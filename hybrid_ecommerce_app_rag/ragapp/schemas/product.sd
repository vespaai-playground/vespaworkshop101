schema product {

  document product {

    field id type int {
      indexing: attribute | summary
    }

    field title type string {
      indexing: index | summary
      index: enable-bm25
    }

    field description type string {
      indexing: index | summary
      index: enable-bm25
    }

    field category type string {
      indexing: attribute | summary
      attribute: fast-search
      match: word
      rank: filter
    }

    field price type int {
      indexing: attribute | summary
    }

    field average_rating type float {
      indexing: attribute | summary
    }

  }

  # DONE: define your "embedding" field here, because it will be "artificially"
  # Embedding field generated from title and description fields during indexing using embedder component
  field embedding type tensor<float>(x[384]) {
    indexing {
      (input title || "") . " " . (input description || "") | embed e5 | attribute | index
    }
    attribute {
      distance-metric: angular
    }
    index {
      hnsw {
        max-links-per-node: 16
        neighbors-to-explore-at-insert: 200
      }
    }
  }

  fieldset default {
    fields: title, description
  }

  # semantic search rank profile. Refer to it in your query by adding:
  # "ranking.profile": "use_closeness"
  rank-profile use_closeness {
    inputs {
      query(q_embedding) tensor<float>(x[384])
    }
    first-phase {
      expression: closeness(field, embedding)
    }
  }

  # DONE: Hybrid search rank profile using Reciprocal Rank Fusion (RRF)
  # Combines semantic search (closeness) with text search (BM25)
  rank-profile rrf inherits use_closeness {
    function best_bm25() {
      expression: max(bm25(title), bm25(description))
    }
    function ann_score() {
      expression: closeness(field, embedding)
    }
    global-phase {
      rerank-count: 200
      expression: reciprocal_rank(ann_score()) + reciprocal_rank(best_bm25())
    }
  }

  document-summary minimal {
    summary id {}
  }

  document-summary medium {
    summary id {}
    summary title {}
    summary description {}
  }

}
